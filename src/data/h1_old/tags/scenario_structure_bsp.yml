name: scenario_structure_bsp
id: sbsp
invaderStructName: ScenarioStructureBSP
comments:
  en: >
    Contains geometric, lighting, weather, and other data for the playable spaces
    in which all objects are placed. Singleplayer maps often use multiple BSPs.
  fields:
    - name: lightmaps bitmap
      en: A reference to the bitmap storing the level's baked [lightmaps](#lightmaps). The level will not be visible without this.
    - name: vehicle floor
      en: >
        The lowest Z-axis height (absolute, not frame relative) that [vehicles][vehicle] can reach while occupied.
        Does not affect other object types. An unoccupied vehicle will still drop
        below this soft barrier, but when it becomes occupied again it will quickly
        shoot back up into the play area. An example of a map using a vehicle floor
        is Gephyrophobia to prevent players from flying too far below the bridge.
    - name: vehicle ceiling
      en: >
        The maximum Z-axis height (absolute, not frame relative) that vehicles can reach while occupied. Does not
        affect other objects types. Above this point, occupied vehicles will
        elastically move back below the ceiling. This can be used to limit the
        height that players in flying vehicles like Banshees can reach for
        gameplay reasons. An example of this can be seen in Blood Gulch.
    - name: default ambient color
      en: ...
    - name: default distant light 0 color
      en: ...
    - name: default distant light 0 direction
      en: ...
    - name: default distant light 1 color
      en: ...
    - name: default distant light 1 direction
      en: ...
    - name: default reflection tint
      en: ...
    - name: default shadow vector
      en: ...
    - name: default shadow color
      en: ...
    - name: collision materials
      en: ...
      fields:
        - name: shader
          en: ...
        - name: material
          en: ...
          options:
            - name: dirt
              en: ...
            - name: sand
              en: ...
            - name: stone
              en: ...
            - name: snow
              en: ...
            - name: wood
              en: ...
            - name: metal hollow
              en: ...
            - name: metal thin
              en: ...
            - name: metal thick
              en: ...
            - name: rubber
              en: ...
            - name: glass
              en: ...
            - name: force field
              en: ...
            - name: grunt
              en: ...
            - name: hunter armor
              en: ...
            - name: hunter skin
              en: ...
            - name: elite
              en: ...
            - name: jackal
              en: ...
            - name: jackal energy shield
              en: ...
            - name: engineer skin
              en: ...
            - name: engineer force field
              en: ...
            - name: flood combat form
              en: ...
            - name: flood carrier form
              en: ...
            - name: cyborg armor
              en: ...
            - name: cyborg energy shield
              en: ...
            - name: human armor
              en: ...
            - name: human skin
              en: ...
            - name: sentinel
              en: ...
            - name: monitor
              en: ...
            - name: plastic
              en: ...
            - name: water
              en: ...
            - name: leaves
              en: ...
            - name: elite energy shield
              en: ...
            - name: ice
              en: ...
            - name: hunter shield
              en: ...
    - name: collision bsp
      en: ...
      fields:
        - name: bsp3d nodes
          en: >
            An block of nodes used to efficiently find collideable surfaces.
            Each node divides space with an infinite plane and references two
            child nodes by index into this block. The first element in the block
            is the root node. A test point can be recursively tested against planes
            to find a _leaf_ of potentially colliding surfaces.
          fields:
            - name: plane
              en: >
                An index into the _planes_ block. The plane divides 3D space in
                two. Generally, tool chooses surfaces to make dividing planes using
                an unknown heuristic. The first few levels of BSP seem to use special
                axis-aligned planes which are stored at the tail of the planes block,
                likely to avoid poor early heuristic choices which would negatively
                affect collision testing performance.
            - name: back child
              en: >
                Index of the bsp3d node representing space to the back of the
                dividing plane. If the index is `-1`, then the space behind the
                plane is considered outside the sealed BSP (Sapien labels this as
                "solid" space when using `debug_structure`). Otherwise, if the
                highest order bit is set (`0x80000000`), the remaining 31 bits
                (mask `0x7FFFFFFF`) represent an index into the _leaves_ block.
            - name: front child
              en: Similar to the _back child_ field.
        - name: planes
          en: >
            Planes are infinite 2D surfaces in 3D space. They are used both to
            subdivide the BSP in each bsp3d node and to define collideable surfaces.
            The first 8 planes in the block seem to serve a special purpose -- the
            first 4 define the XY bounding box, with the next 4 axis aligned planes
            unkown. Furthermore, the last 8 planes in the block are used for the
            first few levels of bsp3d nodes. A single plane may be referenced from
            multiple bsp3d nodes since the surfaces that planes derive from can also
            be found in multiple leaves.
          fields:
            - name: plane
              en: >
                A plane which divides 3D space in two, stored as a 3-float normal
                and _d_ (distance from origin) parameter.
        - name: leaves
          en: >
            Leaves mark the transition between the 3D BSP and a collection of
            convex collideable surfaces in the same localized area. Each set of
            co-planar surfaces within this leaf is stored within a child 2D BSP.

            Note that surfaces may be found under **multiple leaves**, since any
            surface which is not completely on either side of a 3D plane will
            need to belong to both child 3D BSP nodes.
          fields:
            - name: flags
              en: Flags used to optimize collision checks at runtime.
              fields:
                - name: contains double sided surfaces
                  en: >
                    Indicates if any surface in any of this leaf's 2D BSPs is
                    double-sided (e.g. glass).
            - name: bsp2d reference count
              en: Determines how many contiguous 2D BSP references belong to this leaf.
            - name: first bsp2d reference
              en: >
                Index of the first 2D BSP reference associated with this leaf.
                It will be followed by a number of other 2D BSP references according
                to the above count.
        - name: bsp2d references
          en: >
            Represents either a 2D BSP of surfaces, or a singular surface if the
            node index is flagged. In either case, test points or 3D line traces
            should be projected onto the basis plane in order to continue
          fields:
            - name: plane
              en: >
                Index for the plane used to decide what basis plane is best to
                project on (X,Y), (Y,Z) or (X,Z). The basis plane is chosen by
                the referenced plane's most significant normal component. **The
                meaning of a flagged plane index is unknown**.
            - name: bsp2d node
              en: >
                The starting node for the 2D BSP on this plane. If flagged, then
                the index (masked to `0x7FFFFFFF`) refers to a surface instead.
        - name: bsp2d nodes
          en: ...
          fields:
            - name: plane
              en: >
                A 2D plane (line) subdividing left and right child surfaces.
                This line is in the space of the 2D BSP reference's basis plane.
            - name: left child
              en: >
                Index of the left child bsp2d node. If the highest bit is set,
                then the remaining bits (mask `0x7FFFFFFF`) are instead an index
                into the surfaces block.
            - name: right child
              en: Similar to the _left child_ field.
        - name: surfaces
          en: >
            Surfaces are planar collideable polygons. They are not necessarily
            triangular (4 is also common, and Blood Gulch has one with 7 edges),
            and can be visualized in sapien using `debug_structure 1`. These
            surfaces are not used for the rendered geometry.
          fields:
            - name: plane
              en: >
                Index into the planes block for this surface's plane. Note that
                multiple co-planar surfaces may reference the same plane since
                this plane index is a copy of the parent bsp2d reference's
                plane index, even when flagged.
            - name: first edge
              en: ...
            - name: flags
              en: ...
              fields:
                - name: two sided
                  en: ...
                - name: invisible
                  en: ...
                - name: climbable
                  en: Indicates if the surface is a climbable ladder.
                - name: breakable
                  en: >
                    Indicates if the surface is breakable.
                    The surface must also have a breakable surface index below.
            - name: breakable surface
              en: >
                Index into this tag's breakable surfaces block. It is unknown if
                this is a signed or flagged field, but since it is 8-bit there
                cannot be more than 256 unique breakable surfaces in a BSP.
            - name: material
              en: ...
        - name: edges
          en: >
            Edges, surfaces, and vertices form a data structure called a
            _[doubly connected edge list (DCEL)](https://en.wikipedia.org/wiki/Doubly_connected_edge_list)_,
            also known as a _half-edge data structure_. The edges and their vertices
            define the boundaries of the collideable surfaces within a leaf.
          fields:
            - name: start vertex
              en: ...
            - name: end vertex
              en: ...
            - name: forward edge
              en: ...
            - name: reverse edge
              en: ...
            - name: left surface
              en: ...
            - name: right surface
              en: ...
        - name: vertices
          en: >
            The 3D coordinates used for edge starting and ending locations.
          fields:
            - name: point
              en: ...
            - name: first edge
              en: ...
    - name: nodes
      en: ...
      fields:
        - name: node stuff
          en: ...
    - name: world bounds x
      en: ...
    - name: world bounds y
      en: ...
    - name: world bounds z
      en: ...
    - name: leaves
      en: ...
      fields:
        - name: vertices
          en: ...
        - name: cluster
          en: ...
        - name: surface reference count
          en: ...
        - name: surface references
          en: ...
    - name: leaf surfaces
      en: ...
      fields:
        - name: surface
          en: ...
        - name: node
          en: ...
    - name: surfaces
      en: ...
      fields:
        - name: vertex0 index
          en: ...
        - name: vertex1 index
          en: ...
        - name: vertex2 index
          en: ...
    - name: lightmaps
      en: ...
      fields:
        - name: bitmap
          en: ...
        - name: materials
          en: ...
          fields:
            - name: shader
              en: ...
            - name: shader permutation
              en: ...
            - name: flags
              en: ...
              fields:
                - name: coplanar
                  en: ...
                - name: fog plane
                  en: ...
            - name: surfaces
              en: ...
            - name: surface count
              en: ...
            - name: centroid
              en: ...
            - name: ambient color
              en: ...
            - name: distant light count
              en: ...
            - name: distant light 0 color
              en: ...
            - name: distant light 0 direction
              en: ...
            - name: distant light 1 color
              en: ...
            - name: distant light 1 direction
              en: ...
            - name: reflection tint
              en: ...
            - name: shadow vector
              en: ...
            - name: shadow color
              en: ...
            - name: plane
              en: ...
            - name: breakable surface
              en: ...
            - name: rendered vertices count
              en: ...
            - name: rendered vertices offset
              en: ...
            - name: lightmap vertices count
              en: ...
            - name: lightmap vertices offset
              en: ...
            - name: uncompressed vertices
              en: ...
            - name: compressed vertices
              en: ...
    - name: lens flares
      en: Lists the available lens flares used by this BSP's _lens flare markers_.
      fields:
        - name: lens
          en: ...
    - name: lens flare markers
      en: Points within the BSP where a _lens flare_ will be rendered.
      fields:
        - name: position
          en: The 3D position of the lens flare.
        - name: direction i component
          en: ...
        - name: direction j component
          en: ...
        - name: direction k component
          en: ...
        - name: lens flare index
          en: >
            Determines which flare from the [_lens flares_ block](#tag-field-lens-flares)
            is rendered at this position.
    - name: clusters
      en: ...
      fields:
        - name: sky
          en: >-
            Sets which sky is visible when within this cluster. Indexes the
            [_skies_][scenario#tag-field-skies] block of the [scenario][] tag,
            so a value of `0` would mean the first sky, `1` the second, etc. A
            value of `-1` marks this cluster as indoor/interior for the purposes
            of certain [sky][] tag fields.


            It is unknown how exactly [Tool][] determines which clusters are indoor
            when compiling a BSP, but it does validate that all sky faces in a
            cluster are of the same sky. For example, a cluster cannot contain both
            `+sky0` and `+sky1` materials.


            When a player moves between clusters with different skies, there is
            no transition. The sky will abruptly change.
        - name: fog
          en: ...
        - name: background sound
          en: ...
        - name: sound environment
          en: ...
        - name: weather
          en: ...
        - name: transition structure bsp
          en: ...
        - name: first decal index
          en: ...
        - name: decal count
          en: ...
        - name: predicted resources
          en: ...
        - name: subclusters
          en: ...
          fields:
            - name: world bounds x
              en: ...
            - name: world bounds y
              en: ...
            - name: world bounds z
              en: ...
            - name: surface indices
              en: ...
              fields:
                - name: index
                  en: ...
        - name: first lens flare marker index
          en: ...
        - name: lens flare marker count
          en: ...
        - name: surface indices
          en: ...
          fields:
            - name: index
              en: ...
        - name: mirrors
          en: ...
          fields:
            - name: plane
              en: ...
            - name: shader
              en: ...
            - name: vertices
              en: ...
              fields:
                - name: point
                  en: ...
        - name: portals
          en: ...
          fields:
            - name: portal
              en: ...
    - name: cluster data
      en: ...
    - name: cluster portals
      en: ...
      fields:
        - name: front cluster
          en: ...
        - name: back cluster
          en: ...
        - name: plane index
          en: ...
        - name: centroid
          en: ...
        - name: bounding radius
          en: ...
        - name: flags
          en: ...
          fields:
            - name: ai can simply not hear through all this amazing stuff darn it
              en: ...
        - name: vertices
          en: ...
          fields:
            - name: point
              en: ...
    - name: breakable surfaces
      en: ...
      fields:
        - name: centroid
          en: ...
        - name: radius
          en: ...
        - name: collision surface index
          en: ...
    - name: fog planes
      en: ...
      fields:
        - name: front region
          en: ...
        - name: material type
          en: ...
          options:
            - name: dirt
              en: ...
            - name: sand
              en: ...
            - name: stone
              en: ...
            - name: snow
              en: ...
            - name: wood
              en: ...
            - name: metal hollow
              en: ...
            - name: metal thin
              en: ...
            - name: metal thick
              en: ...
            - name: rubber
              en: ...
            - name: glass
              en: ...
            - name: force field
              en: ...
            - name: grunt
              en: ...
            - name: hunter armor
              en: ...
            - name: hunter skin
              en: ...
            - name: elite
              en: ...
            - name: jackal
              en: ...
            - name: jackal energy shield
              en: ...
            - name: engineer skin
              en: ...
            - name: engineer force field
              en: ...
            - name: flood combat form
              en: ...
            - name: flood carrier form
              en: ...
            - name: cyborg armor
              en: ...
            - name: cyborg energy shield
              en: ...
            - name: human armor
              en: ...
            - name: human skin
              en: ...
            - name: sentinel
              en: ...
            - name: monitor
              en: ...
            - name: plastic
              en: ...
            - name: water
              en: ...
            - name: leaves
              en: ...
            - name: elite energy shield
              en: ...
            - name: ice
              en: ...
            - name: hunter shield
              en: ...
        - name: plane
          en: ...
        - name: vertices
          en: ...
          fields:
            - name: point
              en: ...
    - name: fog regions
      en: ...
      fields:
        - name: fog
          en: ...
        - name: weather palette
          en: ...
    - name: fog palette
      en: ...
      fields:
        - name: name
          en: ...
        - name: fog
          en: ...
        - name: fog scale function
          en: ...
    - name: weather palette
      en: ...
      fields:
        - name: name
          en: ...
        - name: particle system
          en: ...
        - name: particle system scale function
          en: ...
        - name: wind
          en: ...
        - name: wind direction
          en: ...
        - name: wind magnitude
          en: ...
        - name: wind scale function
          en: ...
    - name: weather polyhedra
      en: ...
      fields:
        - name: bounding sphere center
          en: ...
        - name: bounding sphere radius
          en: ...
        - name: planes
          en: ...
          fields:
            - name: plane
              en: ...
    - name: pathfinding surfaces
      en: ...
      fields:
        - name: data
          en: ...
    - name: pathfinding edges
      en: ...
      fields:
        - name: midpoint
          en: ...
    - name: background sound palette
      en: ...
      fields:
        - name: name
          en: ...
        - name: background sound
          en: ...
        - name: scale function
          en: ...
    - name: sound environment palette
      en: ...
      fields:
        - name: name
          en: ...
        - name: sound environment
          en: ...
    - name: sound pas data
      en: ...
    - name: markers
      en: >
        Named points with orientation within the BSP. They are similar to
        [gbxmodel markers][gbxmodel#markers] but are not to be confused with
        [scenario _cutscene flags_][scenario#tag-field-cutscene-flags]. These
        markers become visible in [Sapien][] when enabling _snap to markers_ in
        the tool window.
      fields:
        - name: name
          en: ...
        - name: rotation
          en: ...
        - name: position
          en: ...
    - name: detail objects
      en: ...
      fields:
        - name: cells
          en: ...
          fields:
            - name: no name
              en: ...
            - name: no name 1
              en: ...
            - name: no name 2
              en: ...
            - name: no name 3
              en: ...
            - name: no name 4
              en: ...
            - name: no name 5
              en: ...
            - name: no name 6
              en: ...
        - name: instances
          en: ...
          fields:
            - name: no name
              en: ...
            - name: no name 1
              en: ...
            - name: no name 2
              en: ...
            - name: no name 3
              en: ...
            - name: no name 4
              en: ...
        - name: counts
          en: ...
          fields:
            - name: no name
              en: ...
        - name: z reference vectors
          en: ...
          fields:
            - name: no name
              en: ...
            - name: no name 1
              en: ...
            - name: no name 2
              en: ...
            - name: no name 3
              en: ...
        - name: bullshit
          en: ...
    - name: runtime decals
      en: ...
      fields:
        - name: position
          en: ...
        - name: decal type
          en: ...
        - name: yaw
          en: ...
        - name: pitch
          en: ...
    - name: leaf map leaves
      en: ...
      fields:
        - name: faces
          en: ...
          fields:
            - name: node index
              en: ...
            - name: vertices
              en: ...
              fields:
                - name: vertex
                  en: ...
        - name: portal indices
          en: ...
          fields:
            - name: portal index
              en: ...
    - name: leaf map portals
      en: ...
      fields:
        - name: plane index
          en: ...
        - name: back leaf index
          en: ...
        - name: front leaf index
          en: ...
        - name: vertices
          en: ...
          fields:
            - name: point
              en: ...
