name: scenario_structure_bsp
id: sbsp
invaderStructName: ScenarioStructureBSP
comments:
  md: |
    Contains geometric, lighting, weather, and other data for the playable spaces
    in which all objects are placed. Singleplayer maps often use multiple BSPs.
  fields:
    - name: lightmaps bitmap
      md: A reference to the bitmap storing the level's baked [lightmaps](#lightmaps). The level will not be visible without this.
    - name: vehicle floor
      md: |
        The lowest Z-axis height (absolute, not frame relative) that [vehicles][vehicle] can reach while occupied.
        Does not affect other object types. An unoccupied vehicle will still drop
        below this soft barrier, but when it becomes occupied again it will quickly
        shoot back up into the play area. An example of a map using a vehicle floor
        is Gephyrophobia to prevent players from flying too far below the bridge.
    - name: vehicle ceiling
      md: |
        The maximum Z-axis height (absolute, not frame relative) that vehicles can reach while occupied. Does not
        affect other objects types. Above this point, occupied vehicles will
        elastically move back below the ceiling. This can be used to limit the
        height that players in flying vehicles like Banshees can reach for
        gameplay reasons. An example of this can be seen in Blood Gulch.
    - name: default ambient color
      md: ...
    - name: default distant light 0 color
      md: ...
    - name: default distant light 0 direction
      md: ...
    - name: default distant light 1 color
      md: ...
    - name: default distant light 1 direction
      md: ...
    - name: default reflection tint
      md: ...
    - name: default shadow vector
      md: ...
    - name: default shadow color
      md: ...
    - name: collision materials
      md: ...
      fields:
        - name: shader
          md: ...
        - name: material
          md: ...
          options:
            - name: dirt
              md: ...
            - name: sand
              md: ...
            - name: stone
              md: ...
            - name: snow
              md: ...
            - name: wood
              md: ...
            - name: metal hollow
              md: ...
            - name: metal thin
              md: ...
            - name: metal thick
              md: ...
            - name: rubber
              md: ...
            - name: glass
              md: ...
            - name: force field
              md: ...
            - name: grunt
              md: ...
            - name: hunter armor
              md: ...
            - name: hunter skin
              md: ...
            - name: elite
              md: ...
            - name: jackal
              md: ...
            - name: jackal energy shield
              md: ...
            - name: engineer skin
              md: ...
            - name: engineer force field
              md: ...
            - name: flood combat form
              md: ...
            - name: flood carrier form
              md: ...
            - name: cyborg armor
              md: ...
            - name: cyborg energy shield
              md: ...
            - name: human armor
              md: ...
            - name: human skin
              md: ...
            - name: sentinel
              md: ...
            - name: monitor
              md: ...
            - name: plastic
              md: ...
            - name: water
              md: ...
            - name: leaves
              md: ...
            - name: elite energy shield
              md: ...
            - name: ice
              md: ...
            - name: hunter shield
              md: ...
    - name: collision bsp
      md: ...
      fields:
        - name: bsp3d nodes
          md: |
            An block of nodes used to efficiently find collideable surfaces.
            Each node divides space with an infinite plane and references two
            child nodes by index into this block. The first element in the block
            is the root node. A test point can be recursively tested against planes
            to find a _leaf_ of potentially colliding surfaces.
          fields:
            - name: plane
              md: |
                An index into the _planes_ block. The plane divides 3D space in
                two. Generally, tool chooses surfaces to make dividing planes using
                an unknown heuristic. The first few levels of BSP seem to use special
                axis-aligned planes which are stored at the tail of the planes block,
                likely to avoid poor early heuristic choices which would negatively
                affect collision testing performance.
            - name: back child
              md: |
                Index of the bsp3d node representing space to the back of the
                dividing plane. If the index is `-1`, then the space behind the
                plane is considered outside the sealed BSP (Sapien labels this as
                "solid" space when using `debug_structure`). Otherwise, if the
                highest order bit is set (`0x80000000`), the remaining 31 bits
                (mask `0x7FFFFFFF`) represent an index into the _leaves_ block.
            - name: front child
              md: Similar to the _back child_ field.
        - name: planes
          md: |
            Planes are infinite 2D surfaces in 3D space. They are used both to
            subdivide the BSP in each bsp3d node and to define collideable surfaces.
            The first 8 planes in the block seem to serve a special purpose -- the
            first 4 define the XY bounding box, with the next 4 axis aligned planes
            unkown. Furthermore, the last 8 planes in the block are used for the
            first few levels of bsp3d nodes. A single plane may be referenced from
            multiple bsp3d nodes since the surfaces that planes derive from can also
            be found in multiple leaves.
          fields:
            - name: plane
              md: |
                A plane which divides 3D space in two, stored as a 3-float normal
                and _d_ (distance from origin) parameter.
        - name: leaves
          md: |
            Leaves mark the transition between the 3D BSP and a collection of
            convex collideable surfaces in the same localized area. Each set of
            co-planar surfaces within this leaf is stored within a child 2D BSP.

            Note that surfaces may be found under **multiple leaves**, since any
            surface which is not completely on either side of a 3D plane will
            need to belong to both child 3D BSP nodes.
          fields:
            - name: flags
              md: Flags used to optimize collision checks at runtime.
              fields:
                - name: contains double sided surfaces
                  md: |
                    Indicates if any surface in any of this leaf's 2D BSPs is
                    double-sided (e.g. glass).
            - name: bsp2d reference count
              md: Determines how many contiguous 2D BSP references belong to this leaf.
            - name: first bsp2d reference
              md: |
                Index of the first 2D BSP reference associated with this leaf.
                It will be followed by a number of other 2D BSP references according
                to the above count.
        - name: bsp2d references
          md: |
            Represents either a 2D BSP of surfaces, or a singular surface if the
            node index is flagged. In either case, test points or 3D line traces
            should be projected onto the basis plane in order to continue
          fields:
            - name: plane
              md: |
                Index for the plane used to decide what basis plane is best to
                project on (X,Y), (Y,Z) or (X,Z). The basis plane is chosen by
                the referenced plane's most significant normal component. **The
                meaning of a flagged plane index is unknown**.
            - name: bsp2d node
              md: |
                The starting node for the 2D BSP on this plane. If flagged, then
                the index (masked to `0x7FFFFFFF`) refers to a surface instead.
        - name: bsp2d nodes
          md: ...
          fields:
            - name: plane
              md: |
                A 2D plane (line) subdividing left and right child surfaces.
                This line is in the space of the 2D BSP reference's basis plane.
            - name: left child
              md: |
                Index of the left child bsp2d node. If the highest bit is set,
                then the remaining bits (mask `0x7FFFFFFF`) are instead an index
                into the surfaces block.
            - name: right child
              md: Similar to the _left child_ field.
        - name: surfaces
          md: |
            Surfaces are planar collideable polygons. They are not necessarily
            triangular (4 is also common, and Blood Gulch has one with 7 edges),
            and can be visualized in sapien using `debug_structure 1`. These
            surfaces are not used for the rendered geometry.
          fields:
            - name: plane
              md: |
                Index into the planes block for this surface's plane. Note that
                multiple co-planar surfaces may reference the same plane since
                this plane index is a copy of the parent bsp2d reference's
                plane index, even when flagged.
            - name: first edge
              md: ...
            - name: flags
              md: ...
              fields:
                - name: two sided
                  md: ...
                - name: invisible
                  md: ...
                - name: climbable
                  md: Indicates if the surface is a climbable ladder.
                - name: breakable
                  md: |
                    Indicates if the surface is breakable.
                    The surface must also have a breakable surface index below.
            - name: breakable surface
              md: |
                Index into this tag's breakable surfaces block. It is unknown if
                this is a signed or flagged field, but since it is 8-bit there
                cannot be more than 256 unique breakable surfaces in a BSP.
            - name: material
              md: ...
        - name: edges
          md: |
            Edges, surfaces, and vertices form a data structure called a
            _[doubly connected edge list (DCEL)](https://en.wikipedia.org/wiki/Doubly_connected_edge_list)_,
            also known as a _half-edge data structure_. The edges and their vertices
            define the boundaries of the collideable surfaces within a leaf.
          fields:
            - name: start vertex
              md: ...
            - name: end vertex
              md: ...
            - name: forward edge
              md: ...
            - name: reverse edge
              md: ...
            - name: left surface
              md: ...
            - name: right surface
              md: ...
        - name: vertices
          md: |
            The 3D coordinates used for edge starting and ending locations.
          fields:
            - name: point
              md: ...
            - name: first edge
              md: ...
    - name: nodes
      md: ...
      fields:
        - name: node stuff
          md: ...
    - name: world bounds x
      md: ...
    - name: world bounds y
      md: ...
    - name: world bounds z
      md: ...
    - name: leaves
      md: ...
      fields:
        - name: vertices
          md: ...
        - name: cluster
          md: ...
        - name: surface reference count
          md: ...
        - name: surface references
          md: ...
    - name: leaf surfaces
      md: ...
      fields:
        - name: surface
          md: ...
        - name: node
          md: ...
    - name: surfaces
      md: ...
      fields:
        - name: vertex0 index
          md: ...
        - name: vertex1 index
          md: ...
        - name: vertex2 index
          md: ...
    - name: lightmaps
      md: ...
      fields:
        - name: bitmap
          md: ...
        - name: materials
          md: ...
          fields:
            - name: shader
              md: ...
            - name: shader permutation
              md: ...
            - name: flags
              md: ...
              fields:
                - name: coplanar
                  md: ...
                - name: fog plane
                  md: ...
            - name: surfaces
              md: ...
            - name: surface count
              md: ...
            - name: centroid
              md: ...
            - name: ambient color
              md: ...
            - name: distant light count
              md: ...
            - name: distant light 0 color
              md: ...
            - name: distant light 0 direction
              md: ...
            - name: distant light 1 color
              md: ...
            - name: distant light 1 direction
              md: ...
            - name: reflection tint
              md: ...
            - name: shadow vector
              md: ...
            - name: shadow color
              md: ...
            - name: plane
              md: ...
            - name: breakable surface
              md: ...
            - name: rendered vertices count
              md: ...
            - name: rendered vertices offset
              md: ...
            - name: lightmap vertices count
              md: ...
            - name: lightmap vertices offset
              md: ...
            - name: uncompressed vertices
              md: ...
            - name: compressed vertices
              md: ...
    - name: lens flares
      md: ...
      fields:
        - name: lens
          md: ...
    - name: lens flare markers
      md: ...
      fields:
        - name: position
          md: ...
        - name: direction i component
          md: ...
        - name: direction j component
          md: ...
        - name: direction k component
          md: ...
        - name: lens flare index
          md: ...
    - name: clusters
      md: ...
      fields:
        - name: sky
          md: ...
        - name: fog
          md: ...
        - name: background sound
          md: ...
        - name: sound environment
          md: ...
        - name: weather
          md: ...
        - name: transition structure bsp
          md: ...
        - name: first decal index
          md: ...
        - name: decal count
          md: ...
        - name: predicted resources
          md: ...
        - name: subclusters
          md: ...
          fields:
            - name: world bounds x
              md: ...
            - name: world bounds y
              md: ...
            - name: world bounds z
              md: ...
            - name: surface indices
              md: ...
              fields:
                - name: index
                  md: ...
        - name: first lens flare marker index
          md: ...
        - name: lens flare marker count
          md: ...
        - name: surface indices
          md: ...
          fields:
            - name: index
              md: ...
        - name: mirrors
          md: ...
          fields:
            - name: plane
              md: ...
            - name: shader
              md: ...
            - name: vertices
              md: ...
              fields:
                - name: point
                  md: ...
        - name: portals
          md: ...
          fields:
            - name: portal
              md: ...
    - name: cluster data
      md: ...
    - name: cluster portals
      md: ...
      fields:
        - name: front cluster
          md: ...
        - name: back cluster
          md: ...
        - name: plane index
          md: ...
        - name: centroid
          md: ...
        - name: bounding radius
          md: ...
        - name: flags
          md: ...
          fields:
            - name: ai can simply not hear through all this amazing stuff darn it
              md: ...
        - name: vertices
          md: ...
          fields:
            - name: point
              md: ...
    - name: breakable surfaces
      md: ...
      fields:
        - name: centroid
          md: ...
        - name: radius
          md: ...
        - name: collision surface index
          md: ...
    - name: fog planes
      md: ...
      fields:
        - name: front region
          md: ...
        - name: material type
          md: ...
          options:
            - name: dirt
              md: ...
            - name: sand
              md: ...
            - name: stone
              md: ...
            - name: snow
              md: ...
            - name: wood
              md: ...
            - name: metal hollow
              md: ...
            - name: metal thin
              md: ...
            - name: metal thick
              md: ...
            - name: rubber
              md: ...
            - name: glass
              md: ...
            - name: force field
              md: ...
            - name: grunt
              md: ...
            - name: hunter armor
              md: ...
            - name: hunter skin
              md: ...
            - name: elite
              md: ...
            - name: jackal
              md: ...
            - name: jackal energy shield
              md: ...
            - name: engineer skin
              md: ...
            - name: engineer force field
              md: ...
            - name: flood combat form
              md: ...
            - name: flood carrier form
              md: ...
            - name: cyborg armor
              md: ...
            - name: cyborg energy shield
              md: ...
            - name: human armor
              md: ...
            - name: human skin
              md: ...
            - name: sentinel
              md: ...
            - name: monitor
              md: ...
            - name: plastic
              md: ...
            - name: water
              md: ...
            - name: leaves
              md: ...
            - name: elite energy shield
              md: ...
            - name: ice
              md: ...
            - name: hunter shield
              md: ...
        - name: plane
          md: ...
        - name: vertices
          md: ...
          fields:
            - name: point
              md: ...
    - name: fog regions
      md: ...
      fields:
        - name: fog
          md: ...
        - name: weather palette
          md: ...
    - name: fog palette
      md: ...
      fields:
        - name: name
          md: ...
        - name: fog
          md: ...
        - name: fog scale function
          md: ...
    - name: weather palette
      md: ...
      fields:
        - name: name
          md: ...
        - name: particle system
          md: ...
        - name: particle system scale function
          md: ...
        - name: wind
          md: ...
        - name: wind direction
          md: ...
        - name: wind magnitude
          md: ...
        - name: wind scale function
          md: ...
    - name: weather polyhedra
      md: ...
      fields:
        - name: bounding sphere center
          md: ...
        - name: bounding sphere radius
          md: ...
        - name: planes
          md: ...
          fields:
            - name: plane
              md: ...
    - name: pathfinding surfaces
      md: ...
      fields:
        - name: data
          md: ...
    - name: pathfinding edges
      md: ...
      fields:
        - name: midpoint
          md: ...
    - name: background sound palette
      md: ...
      fields:
        - name: name
          md: ...
        - name: background sound
          md: ...
        - name: scale function
          md: ...
    - name: sound environment palette
      md: ...
      fields:
        - name: name
          md: ...
        - name: sound environment
          md: ...
    - name: sound pas data
      md: ...
    - name: markers
      md: ...
      fields:
        - name: name
          md: ...
        - name: rotation
          md: ...
        - name: position
          md: ...
    - name: detail objects
      md: ...
      fields:
        - name: cells
          md: ...
          fields:
            - name: no name
              md: ...
            - name: no name 1
              md: ...
            - name: no name 2
              md: ...
            - name: no name 3
              md: ...
            - name: no name 4
              md: ...
            - name: no name 5
              md: ...
            - name: no name 6
              md: ...
        - name: instances
          md: ...
          fields:
            - name: no name
              md: ...
            - name: no name 1
              md: ...
            - name: no name 2
              md: ...
            - name: no name 3
              md: ...
            - name: no name 4
              md: ...
        - name: counts
          md: ...
          fields:
            - name: no name
              md: ...
        - name: z reference vectors
          md: ...
          fields:
            - name: no name
              md: ...
            - name: no name 1
              md: ...
            - name: no name 2
              md: ...
            - name: no name 3
              md: ...
        - name: bullshit
          md: ...
    - name: runtime decals
      md: ...
      fields:
        - name: position
          md: ...
        - name: decal type
          md: ...
        - name: yaw
          md: ...
        - name: pitch
          md: ...
    - name: leaf map leaves
      md: ...
      fields:
        - name: faces
          md: ...
          fields:
            - name: node index
              md: ...
            - name: vertices
              md: ...
              fields:
                - name: vertex
                  md: ...
        - name: portal indices
          md: ...
          fields:
            - name: portal index
              md: ...
    - name: leaf map portals
      md: ...
      fields:
        - name: plane index
          md: ...
        - name: back leaf index
          md: ...
        - name: front leaf index
          md: ...
        - name: vertices
          md: ...
          fields:
            - name: point
              md: ...
